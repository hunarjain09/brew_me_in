#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ§ª Running e2e tests before push..."
echo "ğŸš€ Starting dev server..."

# Start dev server in background
npm run dev &
DEV_SERVER_PID=$!

# Function to cleanup dev server
cleanup() {
  echo "ğŸ›‘ Stopping dev server..."
  kill $DEV_SERVER_PID 2>/dev/null
  wait $DEV_SERVER_PID 2>/dev/null
}

# Set trap to cleanup on exit
trap cleanup EXIT

# Wait for dev server to be ready (check port 5173)
echo "â³ Waiting for dev server to be ready..."
for i in $(seq 1 60); do
  if nc -z localhost 5173 2>/dev/null; then
    echo "âœ“ Dev server is ready"
    break
  fi
  if [ $i -eq 60 ]; then
    echo "âŒ Dev server failed to start within 60 seconds"
    exit 1
  fi
  sleep 1
done

# Run e2e tests
echo "ğŸ§ª Running tests..."
npm run test:e2e

# Capture test exit code
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "âŒ E2E tests failed. Push aborted."
  echo "ğŸ’¡ Fix the failing tests or use --no-verify to skip this check."
  exit 1
fi

echo "âœ… E2E tests passed. Proceeding with push..."
